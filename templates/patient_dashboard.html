{% extends "base.html" %}

{% block title %}–ì–ª–∞–≤–Ω–∞—è - HealthTrack{% endblock %}

{% block content %}
<!-- –°–µ–∫—Ü–∏—è –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è -->
<div class="welcome-section">
    <h2>üëã –° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º, {{ profile.name }}!</h2>
    <p>{{ current_date }}</p>
</div>

<!-- –°–≤–æ–¥–∫–∞ –∑–∞ —Å–µ–≥–æ–¥–Ω—è -->
<div class="today-summary">
    <div class="summary-card">
        <i class="fas fa-heart"></i>
        <div class="summary-info">
            <h4>–î–∞–≤–ª–µ–Ω–∏–µ</h4>
            <p>
                {% if last_measurement and last_measurement.systolic_bp %}
                    {{ last_measurement.systolic_bp }}/{{ last_measurement.diastolic_bp }}
                {% else %}
                    ‚Äî
                {% endif %}
            </p>
        </div>
    </div>
    <div class="summary-card">
        <i class="fas fa-flask"></i>
        <div class="summary-info">
            <h4>–ì–ª—é–∫–æ–∑–∞</h4>
            <p>
                {% if last_measurement and last_measurement.glucose %}
                    {{ last_measurement.glucose }} –º–º–æ–ª—å/–ª
                {% else %}
                    ‚Äî
                {% endif %}
            </p>
        </div>
    </div>
    <div class="summary-card">
        <i class="fas fa-heartbeat"></i>
        <div class="summary-info">
            <h4>–ü—É–ª—å—Å</h4>
            <p>
                {% if last_measurement and last_measurement.pulse %}
                    {{ last_measurement.pulse }} —É–¥/–º–∏–Ω
                {% else %}
                    ‚Äî
                {% endif %}
            </p>
        </div>
    </div>
    <div class="summary-card">
        <i class="fas fa-weight"></i>
        <div class="summary-info">
            <h4>–í–µ—Å</h4>
            <p>
                {% if last_measurement and last_measurement.weight %}
                    {{ last_measurement.weight }} –∫–≥
                {% else %}
                    ‚Äî
                {% endif %}
            </p>
        </div>
    </div>
</div>

<!-- –ü—Ä–æ—Ñ–∏–ª—å –ø–∞—Ü–∏–µ–Ω—Ç–∞ -->
<div class="card">
    <h3>üë§ –ü—Ä–æ—Ñ–∏–ª—å –ø–∞—Ü–∏–µ–Ω—Ç–∞</h3>
    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 15px;">
        <div>
            <div style="font-size: 0.8rem; color: #666;">–§–ò–û</div>
            <div><strong>{{ profile.surname }} {{ profile.name }} {{ profile.patronim or '' }}</strong></div>
        </div>
        <div>
            <div style="font-size: 0.8rem; color: #666;">–î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è / –ü–æ–ª</div>
            <div>{{ profile.birth_date }} ‚Ä¢ {{ '–ú—É–∂—Å–∫–æ–π' if profile.gender == '–º' else '–ñ–µ–Ω—Å–∫–∏–π' }}</div>
        </div>
        <div>
            <div style="font-size: 0.8rem; color: #666;">–†–æ—Å—Ç / –í–µ—Å</div>
            <div>{{ profile.height or '‚Äî' }} —Å–º / {{ profile.weight or '‚Äî' }} –∫–≥</div>
        </div>
        <div>
            <div style="font-size: 0.8rem; color: #666;">–ö–æ–Ω—Ç–∞–∫—Ç—ã</div>
            <div>{{ profile.email }} ‚Ä¢ {{ profile.phone or '‚Äî' }}</div>
        </div>
    </div>
</div>


<!-- –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è -->
<h3 style="margin: 30px 0 15px 0;">‚ö° –ë—ã—Å—Ç—Ä—ã–µ –¥–µ–π—Å—Ç–≤–∏—è</h3>
<div class="quick-actions">
    <a href="{{ url_for('patient_measurements') }}" class="quick-action-btn">
        <i class="fas fa-chart-line"></i>
        <span>–î–æ–±–∞–≤–∏—Ç—å –ø–æ–∫–∞–∑–∞—Ç–µ–ª–∏</span>
    </a>
    <a href="{{ url_for('patient_diary') }}" class="quick-action-btn">
        <i class="fas fa-book"></i>
        <span>–ó–∞–ø–∏—Å—å –≤ –¥–Ω–µ–≤–Ω–∏–∫</span>
    </a>
    <a href="{{ url_for('patient_prescriptions') }}" class="quick-action-btn">
        <i class="fas fa-pills"></i>
        <span>–ú–æ–∏ –Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è</span>
    </a>
    <a href="{{ url_for('patient_visits') }}" class="quick-action-btn">
        <i class="fas fa-calendar-plus"></i>
        <span>–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –∫ –≤—Ä–∞—á—É</span>
    </a>
</div>

<!-- –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è -->
<h3 style="margin: 30px 0 15px 0;">üìä –ü–æ—Å–ª–µ–¥–Ω–∏–µ –∏–∑–º–µ—Ä–µ–Ω–∏—è</h3>
<div class="measurements-grid">
    {% if measurements %}
        {% for m in measurements[:6] %}
        <div class="measurement-item">
            <div style="font-weight: bold; color: #667eea;">{{ m.measured_at[:10] }}</div>
            {% if m.glucose %}<div>ü©∏ –ì–ª—é–∫–æ–∑–∞: {{ m.glucose }} –º–º–æ–ª—å/–ª</div>{% endif %}
            {% if m.systolic_bp %}<div>‚ù§Ô∏è –î–∞–≤–ª–µ–Ω–∏–µ: {{ m.systolic_bp }}/{{ m.diastolic_bp }}</div>{% endif %}
            {% if m.pulse %}<div>üíì –ü—É–ª—å—Å: {{ m.pulse }} —É–¥/–º–∏–Ω</div>{% endif %}
            {% if m.weight %}<div>‚öñÔ∏è –í–µ—Å: {{ m.weight }} –∫–≥</div>{% endif %}
        </div>
        {% endfor %}
    {% else %}
        <div class="card" style="grid-column: 1 / -1; text-align: center; padding: 30px;">
            <p style="color: #999; margin-bottom: 15px;">–ù–µ—Ç –¥–æ–±–∞–≤–ª–µ–Ω–Ω—ã—Ö –∏–∑–º–µ—Ä–µ–Ω–∏–π</p>
            <a href="{{ url_for('patient_measurements') }}" class="btn btn-primary">
                <i class="fas fa-plus-circle"></i> –î–æ–±–∞–≤–∏—Ç—å –ø–µ—Ä–≤–æ–µ –∏–∑–º–µ—Ä–µ–Ω–∏–µ
            </a>
        </div>
    {% endif %}
</div>
{% endblock %}

@app.route('/patient/dashboard')
def patient_dashboard():
    if 'token' not in session or session['role'] != 'patient':
        print("Patient dashboard: Access denied")
        flash('–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω', 'error')
        return redirect(url_for('login'))

    print(f"Patient dashboard: Fetching profile with token {session['token'][:20]}...")

    # ‚úÖ –í–ê–ñ–ù–û: –ø–µ—Ä–µ–¥–∞—ë–º —Ç–æ–∫–µ–Ω –≤ api_request!
    response = api_request('GET', '/patient/profile', token=session['token'])

    if not response or response.status_code != 200:
        print(f"Profile fetch failed: {response.status_code if response else 'No response'}")
        session.clear()
        flash('–°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞, –ø–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ —Å–Ω–æ–≤–∞', 'error')
        return redirect(url_for('login'))

    profile = response.json()
    session['user_name'] = f"{profile['name']} {profile['surname']}"

    # ‚úÖ –¢–æ–∫–µ–Ω –ø–µ—Ä–µ–¥–∞—ë–º –∏ –¥–ª—è –∏–∑–º–µ—Ä–µ–Ω–∏–π
    measurements_response = api_request('GET', '/patient/measurements', token=session['token'])
    measurements = measurements_response.json()[:10] if measurements_response and measurements_response.status_code == 200 else []

    last_measurement = measurements[0] if measurements else None

    from datetime import datetime
    current_date = datetime.now().strftime('%d.%m.%Y')

    return render_template(
        'patient_dashboard.html',
        profile=profile,
        measurements=measurements,
        last_measurement=last_measurement,
        current_date=current_date
    )